name: Security Scanning

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write
  actions: read

jobs:
  cargo-audit:
    name: Rust Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        id: audit
        continue-on-error: true
        run: |
          # Run audit and save output
          cargo audit --json > audit-results.json
          AUDIT_EXIT=$?

          # Also generate human-readable output
          cargo audit > audit-report.txt 2>&1 || true

          echo "exit_code=$AUDIT_EXIT" >> $GITHUB_OUTPUT

      - name: Parse audit results
        if: always()
        run: |
          if [ -f audit-results.json ]; then
            # Check for vulnerabilities
            VULN_COUNT=$(jq '.vulnerabilities.found | length' audit-results.json 2>/dev/null || echo "0")
            echo "Found $VULN_COUNT vulnerabilities"

            if [ "$VULN_COUNT" -gt "0" ]; then
              echo "## ðŸ”´ Rust Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat audit-report.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

              # Fail the job
              exit 1
            else
              echo "## âœ… No Rust Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cargo-audit-results
          path: |
            audit-results.json
            audit-report.txt
          retention-days: 90

  cargo-deny:
    name: Rust License and Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Create cargo-deny config
        run: |
          cat > deny.toml << 'EOF'
          [advisories]
          ignore = []

          [licenses]
          allow = [
              "MIT",
              "Apache-2.0",
              "Apache-2.0 WITH LLVM-exception",
              "BSD-2-Clause",
              "Unicode-3.0",
          ]
          confidence-threshold = 0.8

          [bans]
          multiple-versions = "warn"

          [sources]
          unknown-registry = "deny"
          unknown-git = "deny"
          EOF

      - name: Run cargo-deny
        run: |
          cargo deny check advisories
          cargo deny check licenses
          cargo deny check bans
          cargo deny check sources

  python-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UV
        uses: astral-sh/setup-uv@v4

      - name: Install pip-audit
        run: uv pip install --system pip-audit

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]" || uv pip install --system pytest ruff mypy

      - name: Run pip-audit
        id: pip_audit
        continue-on-error: true
        run: |
          pip-audit --desc --format json > pip-audit.json
          pip-audit --desc > pip-audit.txt 2>&1 || true
          AUDIT_EXIT=$?
          echo "exit_code=$AUDIT_EXIT" >> $GITHUB_OUTPUT

      - name: Parse pip-audit results
        if: always()
        run: |
          if [ -f pip-audit.json ]; then
            VULN_COUNT=$(jq '[.dependencies[] | select((.vulns | length) > 0)] | length' pip-audit.json 2>/dev/null || echo "0")
            echo "Found $VULN_COUNT vulnerabilities"

            if [ "$VULN_COUNT" -gt "0" ]; then
              echo "## ðŸ”´ Python Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat pip-audit.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

              # Fail the job
              exit 1
            else
              echo "## âœ… No Python Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-results
          path: |
            pip-audit.json
            pip-audit.txt
          retention-days: 90

  codeql-rust:
    name: CodeQL Analysis (Rust)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: rust
          queries: security-and-quality

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build Rust code
        run: cargo build --release

      - name: Perform CodeQL Analysis
        continue-on-error: true
        uses: github/codeql-action/analyze@v3
        with:
          category: rust

  codeql-python:
    name: CodeQL Analysis (Python)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: Perform CodeQL Analysis
        continue-on-error: true
        uses: github/codeql-action/analyze@v3
        with:
          category: python

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-3.0, AGPL-3.0
          comment-summary-in-pr: always

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          wget -qO- https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run gitleaks
        run: |
          gitleaks detect \
            --source . \
            --verbose \
            --report-format json \
            --report-path gitleaks-report.json \
            --exit-code 1

      - name: Upload gitleaks results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 90

      - name: Comment on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âš ï¸ **Secret Scanning Alert**\n\nPotential secrets detected in this PR. Please review the gitleaks report in the workflow artifacts.'
            });

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [cargo-audit, cargo-deny, python-audit, codeql-rust, codeql-python, secret-scanning]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Create security summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # Security Scan Summary ðŸ”’

          ## Scan Results

          | Check | Status |
          |-------|--------|
          | Rust Dependency Audit | ${{ needs.cargo-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | Rust License Check | ${{ needs.cargo-deny.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | Python Dependency Audit | ${{ needs.python-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | CodeQL (Rust) | ${{ needs.codeql-rust.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | CodeQL (Python) | ${{ needs.codeql-python.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | Secret Scanning | ${{ needs.secret-scanning.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |

          ## Next Steps

          - Review any failed checks in the job details
          - Check artifacts for detailed reports
          - Address vulnerabilities before merging

          ---

          *Security scans run automatically on every push and PR, plus daily scheduled scans.*
          EOF

      - name: Check for failures
        run: |
          if [ "${{ needs.cargo-audit.result }}" != "success" ] || \
             [ "${{ needs.python-audit.result }}" != "success" ] || \
             [ "${{ needs.codeql-rust.result }}" != "success" ] || \
             [ "${{ needs.codeql-python.result }}" != "success" ] || \
             [ "${{ needs.secret-scanning.result }}" != "success" ]; then
            echo "::error::One or more security checks failed"
            exit 1
          fi

  create-security-advisory:
    name: Create Security Advisory
    runs-on: ubuntu-latest
    needs: [cargo-audit, python-audit]
    if: |
      failure() &&
      github.event_name == 'schedule' &&
      (needs.cargo-audit.result == 'failure' || needs.python-audit.result == 'failure')
    timeout-minutes: 5

    permissions:
      contents: write
      security-events: write

    steps:
      - name: Create issue for vulnerabilities
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'ðŸ”´ Security vulnerabilities detected';
            const body = `
            ## Security Alert

            Automated security scans have detected vulnerabilities in dependencies.

            **Scan Date:** ${new Date().toISOString()}

            ### Details

            - Check the [Security tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security)
            - Review workflow artifacts for detailed reports
            - Update affected dependencies as soon as possible

            ### Action Items

            - [ ] Review cargo-audit results
            - [ ] Review pip-audit results
            - [ ] Update vulnerable dependencies
            - [ ] Re-run security scans
            - [ ] Close this issue when resolved

            ---

            This issue was automatically created by the Security Scanning workflow.
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title === title
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies']
              });
            }
